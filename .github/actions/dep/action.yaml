name: dep
description: Update dependencies

inputs:
  dependencies-content:
    description: The content of dependencies
    required: true
    default: ""

  target-files:
    description: The files to update dependencies
    required: true

  target-repo:
    description: The pull request target repo
    required: true
    default: "AgoraIO-Extensions/Agora-Flutter-SDK"

  target-branch:
    description: The pull request target branch
    required: true
    default: "main"

  target-path:
    description: The path to update dependencies, if set, will skip clone & pr

  target-branch-name-surffix:
    description: The surffix of the branch name, e.g., if dep-update, the branch name become main-dep-update
    required: true
    default: "dep-update"

  pull-request-title:
    description: The title of the pull request
    required: true
    default: "[AUTO] Update dependencies"

  github-token:
    description: The github token
    required: true

outputs:
  matches:
    description: Dependencies matches
    value: ${{ steps.dep.outputs.matches }}

runs:
  using: composite
  steps:
    - name: Checkout build project
      if: ${{ !inputs.target-path }}
      uses: actions/checkout@v3
      with:
        token: ${{ inputs.github-token }}
        repository: ${{ inputs.target-repo }}
        ref: ${{ inputs.target-branch }}
        path: ${{ inputs.target-repo }}

    - name: Update dependencies
      id: dep
      run: |
        set -x

        ROOT_PATH="${{ github.workspace }}"

        if [[ -n "${{ inputs.target-path }}" ]]; then
          TARGET_PATH="${{ inputs.target-path }}"
        else
          TARGET_PATH="${ROOT_PATH}/${{ inputs.target-repo }}"
        fi

        {
          echo 'matches<<EOF'
          python3 dep.py "${{ inputs.dependencies-content }}" "${TARGET_PATH}" "${{ inputs.target-files }}"
          echo EOF
        } >> "$GITHUB_OUTPUT"
      working-directory: ${{ github.action_path }}
      shell: bash

    - name: Create pull request
      if: ${{ !inputs.target-path }}
      uses: AgoraIO-Extensions/actions/.github/actions/pr@main
      with:
        target-repo: ${{ inputs.target-repo }}
        target-branch: ${{ inputs.target-branch }}
        target-branch-name-surffix: ${{ inputs.target-branch-name-surffix }}
        pull-request-title: ${{ inputs.pull-request-title }}
        pull-request-body: |
          dependencies content: ${{ steps.dep.outputs.matches }}
        github-token: ${{ inputs.github-token }}
